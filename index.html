<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tetris</title>
<style>
  body {
    background:#111;
    color:white;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    font-family:Arial;
  }
  .game { display:flex; gap:20px; }
  canvas { background:black; border:2px solid white; }
</style>
</head>
<body>

<div class="game">
  <canvas id="game" width="240" height="400"></canvas>
  <div>
    <h3>Score</h3><div id="score">0</div>
    <h3>Time</h3><div id="time">0s</div>
    <h3>Next</h3><canvas id="next" width="80" height="80"></canvas>
    <h3>Hold</h3><canvas id="hold" width="80" height="80"></canvas>
  </div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
ctx.scale(20,20);

const nextCtx = document.getElementById("next").getContext("2d");
nextCtx.scale(20,20);
const holdCtx = document.getElementById("hold").getContext("2d");
holdCtx.scale(20,20);

const colors=[null,"#00f0f0","#0000f0","#f0a000","#f0f000","#00f000","#a000f0","#f00000"];

const pieces="ILJOTSZ";
const arena = Array.from({length:20},()=>Array(12).fill(0));

let score=0, time=0, dropInterval=800;
let lastTime=0, dropCounter=0;
let holdPiece=null, canHold=true;

const player={pos:{x:0,y:0},matrix:null};
let nextPiece=randomPiece();

function randomPiece(){ return createPiece(pieces[Math.random()*7|0]); }

function createPiece(t){
  return {
    I:[[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]],
    O:[[2,2],[2,2]],
    T:[[0,1,0],[1,1,1],[0,0,0]],
    S:[[0,6,6],[6,6,0],[0,0,0]],
    Z:[[7,7,0],[0,7,7],[0,0,0]],
    L:[[0,3,0],[0,3,0],[0,3,3]],
    J:[[0,4,0],[0,4,0],[4,4,0]]
  }[t];
}

function collide(){
  return player.matrix.some((r,y)=>
    r.some((v,x)=>
      v && (arena[y+player.pos.y]?.[x+player.pos.x])!==0
    )
  );
}

function merge(){
  player.matrix.forEach((r,y)=>
    r.forEach((v,x)=>{
      if(v) arena[y+player.pos.y][x+player.pos.x]=v;
    })
  );
}

function rotate(m){
  for(let y=0;y<m.length;y++)
    for(let x=0;x<y;x++)
      [m[x][y],m[y][x]]=[m[y][x],m[x][y]];
  m.forEach(r=>r.reverse());
}

function wallKick(){
  const x=player.pos.x;
  for(let i=1;i<4;i++){
    player.pos.x+=i;
    if(!collide()) return;
    player.pos.x-=2*i;
    if(!collide()) return;
  }
  player.pos.x=x;
  rotate(player.matrix);rotate(player.matrix);rotate(player.matrix);
}

function sweep(){
  for(let y=19;y>=0;y--){
    if(arena[y].every(v=>v)){
      arena.splice(y,1);
      arena.unshift(Array(12).fill(0));
      score+=100;
    }
  }
}

function drop(){
  player.pos.y++;
  if(collide()){
    player.pos.y--;
    merge();
    sweep();
    spawn();
  }
  dropCounter=0;
}

function hardDrop(){
  while(!collide()) player.pos.y++;
  player.pos.y--;
  merge();
  sweep();
  spawn();
}

function spawn(){
  player.matrix=nextPiece;
  nextPiece=randomPiece();
  player.pos={x:4,y:0};
  canHold=true;
  if(collide()) arena.forEach(r=>r.fill(0)),score=0;
}

function hold(){
  if(!canHold) return;
  [holdPiece,player.matrix]=[player.matrix,holdPiece||randomPiece()];
  player.pos={x:4,y:0};
  canHold=false;
}

function ghostY(){
  let y=player.pos.y;
  while(!collide()){player.pos.y++;}
  const gy=player.pos.y-1;
  player.pos.y=y;
  return gy;
}

function drawMatrix(m,o,c,alpha=1){
  c.globalAlpha=alpha;
  m.forEach((r,y)=>r.forEach((v,x)=>{
    if(v){
      c.fillStyle=colors[v];
      c.fillRect(x+o.x,y+o.y,1,1);
    }
  }));
  c.globalAlpha=1;
}

function draw(){
  ctx.clearRect(0,0,12,20);
  drawMatrix(arena,{x:0,y:0},ctx);
  drawMatrix(player.matrix,{x:player.pos.x,y:ghostY()},ctx,0.3);
  drawMatrix(player.matrix,player.pos,ctx);

  nextCtx.clearRect(0,0,4,4);
  drawMatrix(nextPiece,{x:0,y:0},nextCtx);

  holdCtx.clearRect(0,0,4,4);
  if(holdPiece) drawMatrix(holdPiece,{x:0,y:0},holdCtx);
}

function update(t=0){
  const d=t-lastTime; lastTime=t;
  dropCounter+=d; time+=d;
  if(dropCounter>dropInterval) drop();
  if(time%15000<50 && dropInterval>150) dropInterval-=50;
  document.getElementById("time").innerText=(time/1000|0)+"s";
  document.getElementById("score").innerText=score;
  draw(); requestAnimationFrame(update);
}

document.addEventListener("keydown",e=>{
  if(e.key==="ArrowLeft"){player.pos.x--;if(collide())player.pos.x++;}
  if(e.key==="ArrowRight"){player.pos.x++;if(collide())player.pos.x--;}
  if(e.key==="ArrowDown") drop();
  if(e.key==="ArrowUp"){rotate(player.matrix);if(collide())wallKick();}
  if(e.code==="Space") hardDrop();
  if(e.key==="Shift") hold();
});

spawn();
update();
</script>
</body>
</html>
